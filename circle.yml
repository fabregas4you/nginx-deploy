machine:
  timezone:
    Asia/Tokyo
  services:
    - docker
  python:
    version: 2.7.12

dependencies:  
  pre:
    - pip install ansible
    - pip install --upgrade setuptools
    - docker build -t centos6.8/nginx-rpm -f dockerfile-6.8 .
    # destory docker -rm ,if you want
    # - docker run --rm -v $CIRCLE_ARTIFACTS:/shared:rw centos6.8/nginx-rpm /bin/sh ./nginxbuild.sh
    - docker run -v $CIRCLE_ARTIFACTS:/shared:rw centos6.8/nginx-rpm /bin/sh ./nginxbuild.sh
    # - docker build -t centos6.8/nginx-test -f dockerfile-6.8 .

test:
  pre:
    - bundle -j4 --path=vendor/bundle
    - mkdir -p ~/.ssh/
    - cp $HOME/$CIRCLE_PROJECT_REPONAME/ssh/config ~/.ssh/config
    - cp $HOME/$CIRCLE_PROJECT_REPONAME/ssh/id_rsa ~/.ssh/id_rsa
    - cp $HOME/$CIRCLE_PROJECT_REPONAME/ssh/id_rsa.pub ~/.ssh/id_rsa.pub
    - sudo chown 600 ~/.ssh/id_rsa
  override:
    ## sample
    # - docker run -i -t bokiboki/circleci-test /spec_start.sh
    # - docker run --name centos68-ssh -d -p 40022:22 -e SSH_KEY="$(cat ~/.ssh/id_rsa.pub)" docker
    ## install rpm on  docker
    # - cd ansible && ansible-playbook -i inventory playbook.yml
    # - cd ansible && ansible-playbook -i inventory playbook.yml -u docker --private-key="~/.ssh/id_rsa"
    ## install local rpm 
    #- docker run --rm -it centos6.8/nginx-rpm rpm -ivh /var/tmp/rpmbuild/RPMS/x86_64/nginx-1.12.1-0.el6.x86_64.rpm
    #
    - docker run --rm -it centos6.8/nginx-rpm ls -la /var/tmp/rpmbuild/*/*
    # - cd serverspec && bundle exec rake spec
  # post:

# deployment:
#   release:
#     branch: master
#     commands:
#       - go get github.com/aktau/github-release
#       - cp $CIRCLE_ARTIFACTS/*.rpm .
#       - /bin/sh ./github-release.sh
